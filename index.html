<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BULLPEN - Final</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f3f6fb; color:#0f172a; }
    header { background:#2563eb; color:#fff; padding:14px 16px; text-align:center; font-weight:700; }
    .wrap { max-width:820px; margin:18px auto; padding:12px; }
    .card { background:#fff; border-radius:10px; padding:14px; box-shadow:0 6px 18px rgba(16,24,40,0.06); margin-bottom:14px;}
    label{display:block; margin:6px 0 4px; font-weight:600;}
    input[type="number"], input[type="text"], input[type="password"], select {
      width:100%; padding:10px; border-radius:8px; border:1px solid #d1d5db; box-sizing:border-box;
    }
    button { background:#2563eb; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
    button.gray { background:#6b7280; }
    .row { display:flex; gap:10px; }
    .col { flex:1; }
    nav { position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid #e6eefc; display:flex; }
    nav button { flex:1; padding:12px; border:none; background:transparent; font-weight:600; }
    .small { font-size:13px; color:#374151; }
    .muted { color:#6b7280; font-size:13px; }
    .pending { background:#fff7ed; padding:8px; border-radius:8px; margin-top:8px; }
    table { width:100%; border-collapse:collapse; }
    td, th { padding:8px; border-bottom:1px solid #f1f5f9; text-align:left; font-size:14px; }
  </style>
</head>
<body>
<header>BULLPEN — Final (Admin protected)</header>

<div class="wrap">
  <!-- HOME -->
  <div id="home" class="card">
    <h3>Deposit</h3>
    <label>Amount (৳)</label>
    <input id="depositAmount" type="number" placeholder="Enter amount (e.g. 100)">

    <label>Method</label>
    <select id="depositMethod">
      <option value="bkash">bKash</option>
      <option value="nagad">Nagad</option>
    </select>

    <label>Transaction ID (Txn ID)</label>
    <input id="depositTxnId" type="text" placeholder="Enter Transaction ID from bkash/nagad">

    <div style="margin-top:10px;">
      <button onclick="submitDeposit()">Submit Deposit (Pending)</button>
      <button class="gray" onclick="goPage('profile')">My Profile</button>
    </div>

    <hr style="margin:12px 0;">
    <h3>Withdraw</h3>
    <label>Amount (৳)</label>
    <input id="withdrawAmount" type="number" placeholder="Enter withdraw amount">
    <div style="margin-top:10px;">
      <button onclick="submitWithdraw()">Request Withdraw (Pending)</button>
    </div>

    <hr style="margin:12px 0;">
    <h3>Daily Check-in</h3>
    <p class="muted">Deposit approved হলে প্রতিদিন একবার Check-in করে deposit-এর 10% পাওয়া যাবে।</p>
    <button id="checkInBtn" onclick="doCheckIn()" disabled>Check In</button>
  </div>

  <!-- PROFILE -->
  <div id="profile" class="card" style="display:none;">
    <h3>My Profile</h3>
    <p><strong>Balance:</strong> <span id="balance">0</span> ৳</p>
    <p class="small"><strong>Active approved deposit daily:</strong> <span id="dailyAmount">0</span> ৳/day</p>
    <p class="small"><strong>Refer bonus given:</strong> <span id="referFlag">No</span></p>
    <p class="small"><strong>Last check-in:</strong> <span id="lastCheckIn">—</span></p>

    <hr>
    <h4>Transactions</h4>
    <div id="history">No history yet</div>

    <div style="margin-top:10px;">
      <button onclick="goPage('home')">Back</button>
    </div>
  </div>

  <!-- REFER -->
  <div id="refer" class="card" style="display:none;">
    <h3>Refer & Earn</h3>
    <p class="muted">Refer করলে referee-এর প্রথম successful deposit হলে তোমার বেলারেন্সে একবার 10% যাবে।</p>
    <label>Refer link</label>
    <input id="referLink" type="text" readonly value="https://yourapp.com/ref123">
    <div style="margin-top:10px;">
      <button onclick="copyRef()">Copy Link</button>
    </div>
    <div style="margin-top:10px;">
      <button onclick="goPage('home')">Back</button>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="admin" class="card" style="display:none;">
    <h3>Admin Panel</h3>
    <label>Admin Password</label>
    <input id="adminPass" type="password" placeholder="Enter admin password">
    <div style="margin-top:10px;">
      <button onclick="adminLogin()">Login</button>
    </div>

    <div id="adminControls" style="display:none; margin-top:12px;">
      <h4>Pending Deposits</h4>
      <div id="pendingDeposits">No pending deposits</div>

      <label>Txn ID to Approve</label>
      <input id="approveTxn" type="text" placeholder="Enter txn id to approve">
      <div style="margin-top:8px;">
        <button onclick="approveDeposit()">Approve Deposit</button>
      </div>

      <hr>
      <h4>Pending Withdraws</h4>
      <div id="pendingWithdraws">No pending withdraws</div>

      <label>Withdraw Amount to Approve</label>
      <input id="approveWithdrawAmt" type="number" placeholder="Enter withdraw amount to approve">
      <div style="margin-top:8px;">
        <button onclick="approveWithdraw()">Approve Withdraw</button>
      </div>

      <hr>
      <h4>Admin Actions</h4>
      <button onclick="adminLogout()">Logout</button>
      <p class="muted">Admin password: <strong>Tasnia91223</strong></p>
    </div>
  </div>
</div>

<nav>
  <button onclick="goPage('home')">Home</button>
  <button onclick="goPage('profile')">Profile</button>
  <button onclick="goPage('refer')">Refer</button>
  <button onclick="goPage('admin')">Admin</button>
</nav>

<script>
/* -------------------------
   CONFIG / STATE (local)
   ------------------------- */
const ADMIN_PASSWORD = "Tasnia91223"; // <-- admin password as requested

let state = {
  balance: 0,
  approvedDeposit: null,   // { amount, method, txnId, approvedAt(ms), dailyAmount }
  pendingDeposit: null,    // { amount, method, txnId, submittedAt }
  pendingWithdraw: null,   // { amount, submittedAt }
  history: [],             // array of {type, desc, time}
  referBonusGiven: false,
  lastCheckInDate: null,
  adminLoggedIn: false
};

/* load saved from localStorage */
function loadState(){
  try {
    const raw = localStorage.getItem('bullpen_state_v1');
    if(raw) {
      const s = JSON.parse(raw);
      Object.assign(state, s || {});
    }
  } catch(e){ console.warn("loadState:", e); }
}
function saveState(){
  try {
    localStorage.setItem('bullpen_state_v1', JSON.stringify(state));
  } catch(e){ console.warn("saveState:", e); }
}

/* -------------------------
   Helper utilities
   ------------------------- */
function fmtDate(ts){ return new Date(ts).toLocaleString(); }
function nowMs(){ return Date.now(); }
function round2(n){ return Math.round(n*100)/100; }

/* -------------------------
   UI management
   ------------------------- */
function goPage(page){
  ['home','profile','refer','admin'].forEach(id => {
    document.getElementById(id).style.display = (id===page)?'block':'none';
  });
  renderUI();
}

function renderUI(){
  document.getElementById('balance').innerText = round2(state.balance);
  document.getElementById('referFlag').innerText = state.referBonusGiven ? 'Yes' : 'No';
  document.getElementById('lastCheckIn').innerText = state.lastCheckInDate || '—';

  // daily amount from approved deposit
  const daily = state.approvedDeposit ? state.approvedDeposit.dailyAmount : 0;
  document.getElementById('dailyAmount').innerText = round2(daily);

  // pending lists
  const pd = state.pendingDeposit;
  document.getElementById('pendingDeposits').innerHTML = pd ? (
    `<div class="pending"><strong>Txn:</strong> ${pd.txnId} | <strong>Amt:</strong> ${pd.amount}৳ | <strong>Method:</strong> ${pd.method}</div>`
  ) : '<div class="muted">No pending deposits</div>';

  const pw = state.pendingWithdraw;
  document.getElementById('pendingWithdraws').innerHTML = pw ? (
    `<div class="pending"><strong>Amt:</strong> ${pw.amount}৳ | <span class="small">submitted: ${fmtDate(pw.submittedAt)}</span></div>`
  ) : '<div class="muted">No pending withdraws</div>';

  // history
  if(state.history.length){
    const rows = state.history.slice().reverse().map(h => `<tr><td>${h.type}</td><td>${h.desc}</td><td>${new Date(h.time).toLocaleString()}</td></tr>`).join('');
    document.getElementById('history').innerHTML = `<table><thead><tr><th>Type</th><th>Desc</th><th>Time</th></tr></thead><tbody>${rows}</tbody></table>`;
  } else {
    document.getElementById('history').innerHTML = '<div class="muted">No history yet</div>';
  }

  // check-in button enabling only if there's an approved deposit
  document.getElementById('checkInBtn').disabled = !state.approvedDeposit;

  // admin controls
  if(state.adminLoggedIn){
    document.getElementById('adminControls').style.display = 'block';
    document.getElementById('adminPass').value = '';
  } else {
    document.getElementById('adminControls').style.display = 'none';
  }
}

/* -------------------------
   Startup: load and reconcile daily additions
   ------------------------- */
loadState();

/* If there's an approved deposit, compute any missed daily additions since last approvedAt:
   We'll store approvedAt as ms. When approving, we set approvedAt = Date.now()
   If page closed and reopened after N full days, we add N * dailyAmount to balance and bump approvedAt forward.
*/
function reconcileApprovedDeposit(){
  if(!state.approvedDeposit) return;
  const ap = state.approvedDeposit;
  const now = nowMs();
  const msPerDay = 24*60*60*1000;
  // compute full days passed since approvedAt
  const delta = now - (ap.approvedAt || now);
  if(delta < msPerDay) return;
  const days = Math.floor(delta / msPerDay);
  if(days > 0){
    const total = days * ap.dailyAmount;
    state.balance = round2(state.balance + total);
    // advance approvedAt
    ap.approvedAt = ap.approvedAt + days * msPerDay;
    state.history.push({type:'auto-daily', desc:`${days} day(s) auto-added ${round2(total)}৳ (daily ${round2(ap.dailyAmount)}৳)`, time: now});
    saveState();
  }
}
reconcileApprovedDeposit();
/* also start runtime interval for adding daily when page is open */
function startDailyInterval(){
  if(!state.approvedDeposit) return;
  // clear existing timer if any
  if(window._dailyInterval) clearInterval(window._dailyInterval);
  // next add will happen in exactly 24h from now (we already reconciled past full days)
  window._dailyInterval = setInterval(() => {
    const ap = state.approvedDeposit;
    if(!ap) return;
    state.balance = round2(state.balance + ap.dailyAmount);
    ap.approvedAt = nowMs();
    state.history.push({type:'auto-daily', desc:`auto-added ${round2(ap.dailyAmount)}৳`, time: nowMs()});
    saveState(); renderUI();
  }, 24*60*60*1000);
}
startDailyInterval();

/* initial render */
renderUI();

/* -------------------------
   User actions
   ------------------------- */
function submitDeposit(){
  const amt = Number(document.getElementById('depositAmount').value);
  const method = document.getElementById('depositMethod').value;
  const txn = document.getElementById('depositTxnId').value.trim();
  if(!amt || !txn){ alert('Amount and Transaction ID required'); return; }
  state.pendingDeposit = { amount: round2(amt), method, txnId: txn, submittedAt: nowMs() };
  state.history.push({type:'deposit-pending', desc:`Txn ${txn} amount ${amt}৳ via ${method}`, time: nowMs()});
  saveState();
  renderUI();
  alert('Deposit submitted and pending admin approval.');
}

function submitWithdraw(){
  const amt = Number(document.getElementById('withdrawAmount').value);
  if(!amt){ alert('Enter withdraw amount'); return; }
  if(amt > state.balance){ alert('Not enough balance'); return; }
  state.pendingWithdraw = { amount: round2(amt), submittedAt: nowMs() };
  state.history.push({type:'withdraw-pending', desc:`Withdraw request ${amt}৳`, time: nowMs()});
  saveState();
  renderUI();
  alert('Withdraw requested and pending admin approval.');
}

function doCheckIn(){
  if(!state.approvedDeposit){ alert('No approved deposit yet'); return; }
  const today = new Date().toDateString();
  if(state.lastCheckInDate === today){ alert('Already checked in today'); return; }
  const bonus = round2(state.approvedDeposit.amount * 0.10);
  state.balance = round2(state.balance + bonus);
  state.lastCheckInDate = today;
  state.history.push({type:'checkin', desc:`Check-in bonus ${bonus}৳`, time: nowMs()});
  saveState();
  renderUI();
  alert('Check-in bonus added: ' + bonus + '৳');
}

function copyRef(){
  const el = document.getElementById('referLink');
  el.select(); el.setSelectionRange(0,99999);
  document.execCommand('copy');
  alert('Refer link copied');
}

/* -------------------------
   Admin actions
   ------------------------- */
function adminLogin(){
  const pass = document.getElementById('adminPass').value;
  if(pass === ADMIN_PASSWORD){
    state.adminLoggedIn = true;
    state.adminLoggedAt = nowMs();
    saveState();
    renderUI();
    alert('Admin logged in');
  } else {
    alert('Incorrect password');
  }
}

function adminLogout(){
  state.adminLoggedIn = false;
  saveState();
  renderUI();
  alert('Admin logged out');
}

function approveDeposit(){
  if(!state.adminLoggedIn){ alert('Admin login required'); return; }
  if(!state.pendingDeposit){ alert('No pending deposit'); return; }
  const id = document.getElementById('approveTxn').value.trim();
  if(id !== state.pendingDeposit.txnId){ alert('Txn ID mismatch'); return; }

  // Approve: set approvedDeposit and start daily accrual (40% of amount per day)
  const p = state.pendingDeposit;
  const dailyAmount = round2(p.amount * 0.40); // 40% of deposit per day
  state.approvedDeposit = { amount: p.amount, method: p.method, txnId: p.txnId, approvedAt: nowMs(), dailyAmount };
  state.pendingDeposit = null;

  // Give refer bonus once (10% of deposit) if not yet given
  if(!state.referBonusGiven){
    const referBonus = round2(state.approvedDeposit.amount * 0.10);
    state.balance = round2(state.balance + referBonus);
    state.referBonusGiven = true;
    state.history.push({type:'refer-bonus', desc:`Refer bonus ${referBonus}৳`, time: nowMs()});
  }

  // When approving we do NOT immediately add dailyAmount as a lump sum.
  // But to reflect user's expectation, we may optionally add today's share only if desired.
  // We'll not add immediate dailyAmount; instead reconcile logic will add days passed when needed
  // and start the interval for future daily additions.

  state.history.push({type:'deposit-approved', desc:`Deposit ${state.approvedDeposit.amount}৳ approved (daily ${state.approvedDeposit.dailyAmount}৳)`, time: nowMs()});
  saveState();
  startDailyInterval();
  renderUI();
  alert('Deposit approved. Daily accrual started: ' + state.approvedDeposit.dailyAmount + '৳ per day.');
}

function approveWithdraw(){
  if(!state.adminLoggedIn){ alert('Admin login required'); return; }
  if(!state.pendingWithdraw){ alert('No pending withdraw'); return; }
  const amtInput = Number(document.getElementById('approveWithdrawAmt').value);
  if(!amtInput || amtInput !== state.pendingWithdraw.amount){ alert('Enter the correct withdraw amount to approve'); return; }
  // Deduct
  state.balance = round2(state.balance - state.pendingWithdraw.amount);
  state.history.push({type:'withdraw-approved', desc:`Withdraw ${state.pendingWithdraw.amount}৳ approved`, time: nowMs()});
  state.pendingWithdraw = null;
  saveState();
  renderUI();
  alert('Withdraw approved and balance deducted.');
}

/* -------------------------
   Expose quick debug helpers (optional)
   ------------------------- */
window._state = state;
window._saveState = saveState;
window._loadState = loadState;

/* ensure UI refresh periodically (for demo) */
setInterval(() => { reconcileApprovedDeposit(); saveState(); renderUI(); }, 60*1000); // every minute reconcile

</script>
</body>
</html>
